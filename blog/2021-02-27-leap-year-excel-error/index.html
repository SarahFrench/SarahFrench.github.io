<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><style>@import 'https://fonts.googleapis.com/css2?family=VT323&display=swap'</style><link rel=stylesheet href=http://localhost:1313/sass/main.css><script>document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector("#menu"),t=new IntersectionObserver((e)=>{console.log("callback fired");const n=e[0];n.target.classList.toggle("nav--pinned",n.intersectionRatio<1)},{threshold:[1]});t.observe(e)})</script><title>When is a leap year not a leap year? Don't ask Microsoft Excel | Sarah French</title></head><body><nav id=menu class=nav><a class=nav-link href=/ title=Home>Home</a>
<a class=nav-link href=/blog/ title=Blog>Blog</a>
<a class=nav-link href=/project/ title=Projects>Projects</a></nav><svg class="hero hero--subpage" width="100%" height="100%" viewBox="0 0 800 100" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:1.5"><g transform="matrix(1,0,0,1,1,-196.312)"><g transform="matrix(1,0,0,0.506741,0,197.407)"><rect x="-.829" y="-2.161" width="801.197" height="402.37" style="fill:#12022d"/></g><g id="veticals"><g transform="matrix(0.999999,-0.000112464,-0.00011259,0.97537,6.20178,10.4171)"><path d="M393.82 194.416 393.843 399.466" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(0.999999,-0.000112464,-0.00011259,0.97537,6.20178,10.4171)"><path d="M416.82 194.418c17.341 68.353 52.023 205.057 52.023 205.057" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(0.999999,-0.000112464,-0.00011259,0.97537,6.20178,10.4171)"><path d="M439.82 194.421 546.843 399.484" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(0.999999,-0.000112464,-0.00011259,0.97537,6.20178,10.4171)"><path d="M462.82 194.424 623.844 399.493" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(0.999999,-0.000112464,-0.00011259,0.97537,6.20178,10.4171)"><path d="M485.82 194.426 699.727 400.248" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(0.999999,-0.000112464,-0.00011259,0.97537,6.20178,10.4171)"><path d="M507.82 194.429 773.844 399.51" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(0.999999,-0.000112464,-0.00011259,0.97537,6.20178,10.4171)"><path d="M532.82 194.432 793.839 362.588" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(0.999999,-0.000112464,-0.00011259,0.97537,6.20178,10.4171)"><path d="M550.82 194.434 793.835 326.59" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(0.999999,-0.000112464,-0.00011259,0.97537,6.20178,10.4171)"><path d="M573.82 194.436 793.832 300.223" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(0.999999,-0.000112464,-0.00011259,0.97537,6.20178,10.4171)"><path d="M597.82 194.439l196.01 83.156" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(0.999999,-0.000112464,-0.00011259,0.97537,6.20178,10.4171)"><path d="M618.82 194.442l175.008 65.906" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(0.999999,-0.000112464,-0.00011259,0.97537,6.20178,10.4171)"><path d="M640.82 194.444l153.006 51.093" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(0.999999,-0.000112464,-0.00011259,0.97537,6.20178,10.4171)"><path d="M661.82 194.447l132.005 39.408" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(0.999999,-0.000112464,-0.00011259,0.97537,6.20178,10.4171)"><path d="M681.82 194.449l112.004 30.77" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(0.999999,-0.000112464,-0.00011259,0.97537,6.20178,10.4171)"><path d="M703.82 194.451 793.823 217.017" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(0.999999,-0.000112464,-0.00011259,0.97537,6.20178,10.4171)"><path d="M722.82 194.454l71.002 15.393" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(0.999999,-0.000112464,-0.00011259,0.97537,6.20178,10.4171)"><path d="M740.821 194.456 793.821 202.96" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(0.999999,-0.000112464,-0.00011259,0.97537,6.20178,10.4171)"><path d="M757.821 194.458 793.821 197.538" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(0.999999,-0.000112464,-0.00011259,0.97537,6.20178,10.4171)"><path d="M773.821 194.46 793.821 194.462" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(-0.999999,-0.000112464,0.00011259,0.97537,793.798,10.4171)"><path d="M416.82 194.418c17.341 68.353 52.023 205.057 52.023 205.057" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(-0.999999,-0.000112464,0.00011259,0.97537,793.798,10.4171)"><path d="M439.82 194.421 546.843 399.484" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(-0.999999,-0.000112464,0.00011259,0.97537,793.798,10.4171)"><path d="M462.82 194.424 623.844 399.493" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(-0.999999,-0.000112464,0.00011259,0.97537,793.798,10.4171)"><path d="M485.82 194.426 699.727 400.248" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(-0.999999,-0.000112464,0.00011259,0.97537,793.798,10.4171)"><path d="M507.82 194.429 773.844 399.51" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(-0.999999,-0.000112464,0.00011259,0.97537,793.798,10.4171)"><path d="M532.82 194.432 793.839 362.588" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(-0.999999,-0.000112464,0.00011259,0.97537,793.798,10.4171)"><path d="M550.82 194.434 793.835 326.59" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(-0.999999,-0.000112464,0.00011259,0.97537,793.798,10.4171)"><path d="M573.82 194.436 793.832 300.223" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(-0.999999,-0.000112464,0.00011259,0.97537,793.798,10.4171)"><path d="M597.82 194.439l196.01 83.156" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(-0.999999,-0.000112464,0.00011259,0.97537,793.798,10.4171)"><path d="M618.82 194.442l175.008 65.906" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(-0.999999,-0.000112464,0.00011259,0.97537,793.798,10.4171)"><path d="M640.82 194.444l153.006 51.093" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(-0.999999,-0.000112464,0.00011259,0.97537,793.798,10.4171)"><path d="M661.82 194.447l132.005 39.408" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(-0.999999,-0.000112464,0.00011259,0.97537,793.798,10.4171)"><path d="M681.82 194.449l112.004 30.77" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(-0.999999,-0.000112464,0.00011259,0.97537,793.798,10.4171)"><path d="M703.82 194.451 793.823 217.017" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(-0.999999,-0.000112464,0.00011259,0.97537,793.798,10.4171)"><path d="M722.82 194.454l71.002 15.393" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(-0.999999,-0.000112464,0.00011259,0.97537,793.798,10.4171)"><path d="M740.821 194.456 793.821 202.96" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(-0.999999,-0.000112464,0.00011259,0.97537,793.798,10.4171)"><path d="M757.821 194.458 793.821 197.538" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g><g transform="matrix(-0.999999,-0.000112464,0.00011259,0.97537,793.798,10.4171)"><path d="M773.821 194.46 793.821 194.462" style="fill:none;stroke:#ff00a6;stroke-width:2.03px"/></g></g><g id="horizontals"><path d="M0 365 8e2 365.024" style="fill:none;stroke:#8a8ac9;stroke-width:1px"/><path d="M0 328H8e2" style="fill:none;stroke:#8a8ac9;stroke-width:1px"/><path d="M8e2 302H0" style="fill:none;stroke:#8a8ac9;stroke-width:1px"/><path d="M0 280H8e2" style="fill:none;stroke:#8a8ac9;stroke-width:1px"/><path d="M8e2 263.6.0 263.843" style="fill:none;stroke:#8a8ac9;stroke-width:1px"/><path d="M0 249.563 8e2 249.576" style="fill:none;stroke:#8a8ac9;stroke-width:1px"/><path d="M0 237.737 8e2 237.846" style="fill:none;stroke:#8a8ac9;stroke-width:1px"/><path d="M0 230H8e2" style="fill:none;stroke:#8a8ac9;stroke-width:1px"/><path d="M-.092 222H8e2" style="fill:none;stroke:#8a8ac9;stroke-width:1px"/><path d="M0 215 8e2 214.978" style="fill:none;stroke:#8a8ac9;stroke-width:1px"/><path d="M.149 209H8e2" style="fill:none;stroke:#8a8ac9;stroke-width:1px"/><path d="M0 203H8e2" style="fill:none;stroke:#8a8ac9;stroke-width:1px"/><g transform="matrix(1,0,0,1,0,-1)"><path d="M0 2e2H8e2.0z" style="fill:none;stroke:#8a8ac9;stroke-width:1px"/></g></g></g></svg><div class="main-wrapper main-wrapper--subpage"><main class=main-content><article class=blog-post><div class="tag-list__list styled-font"><a class=tag-list__item href=/tags/bugs>Bugs</a></div><header><h1 class="styled-font page-title">When is a leap year not a leap year? Don't ask Microsoft Excel</h1></header><p class=blog__date>February 27, 2021</p><p>Dates and times always have the potential to cause trouble in code; back in my apprenticeship, my teacher drove this point home by sharing a great article called <a href=https://infiniteundo.com/post/25326999628/falsehoods-programmers-believe-about-time rel="noopener noreferrer nofollow" target=_blank>Falsehoods programmers believe about time</a>. Since then I&rsquo;ve been wary of working with data that relies heavily on dates. (If you cannot tell, this paragraph&rsquo;s job is to supply foreshadowing).</p><p>In a recent project at work, I&rsquo;ve been collecting Covid-19 data from various government sources and consolidating them into one standardised collection. The best scenario is that a country&rsquo;s government has a well-documented API. Typically countries seem to publish daily PDFs or CSVs that keep having data appended to the bottom. The worst-case was a certain health ministry&rsquo;s website that would include yesterdays data in the homepage&rsquo;s HTML and then update the HTML the next day with the previous day&rsquo;s stats.</p><p>An interesting date problem I recently encountered was in the data from Belgium. Belgium publishes its Covid-19 data in an Excel file with separate pages for cases, deaths and tests data, and when parsing the file using some JavaScript I found that one of these pages was returning dates as a number instead of a string. This is because Excel uses the 1900 date system where dates are expressed, behind the scenes, as the number of days after the start of 1900. Ok then. I started writing a function to convert the number into a date string that matched the dates from the other pages.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#ff79c6>const</span> convertExcelTimeToTimestamp <span style=color:#ff79c6>=</span> (dataValue) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>const</span> DAYS_OFFSET <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>25569</span>; <span style=color:#6272a4>//days between start of 1900 and 1970
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>const</span> MILLISECONDS_IN_A_DAY <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>86400000</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>const</span> unixDate <span style=color:#ff79c6>=</span> (dateValue – DAYS_OFFSET) <span style=color:#ff79c6>*</span> MILLISECONDS_IN_A_DAY;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>const</span> timestamp <span style=color:#ff79c6>=</span>  moment(unixDate).format(<span style=color:#f1fa8c>&#39;YYYY-MM-DD&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> timestamp
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The function subtracts the number of days between the start of 1900 and 1970 from the input, to get the date in +/- days relative to 01/01/1970. Multiplying this by the number of milliseconds in a day gets a Unix time value that&rsquo;s usable in JavaScript. To figure out the value of <code>DAYS_OFFSET</code> I initially used an online date difference calculator to get the rough value and then relied on a unit test to check it&rsquo;s correct. I took the first 1900 date serial number from the Belgian Excel spreadsheet, 43891, and made a test asserting that the function returned the date shown in Excel, “2020-03-01”. Cool, test passes, done.</p><p>But then I ended up in a confusing loop when I began adding more unit tests.</p><p>The definition of the 1900 date system said that it starts with 1 = 01/01/1900, so I made a unit test to assert this. But that test failed due to an out-by-one error. Confused, I then adjusted the function&rsquo;s calculations to make that test pass, but this then caused the tests for dates in 2020 to start failing with an out-by-one error instead. This left me scratching my head&mldr; why would the function work differently at low and high input values?</p><pre tabindex=0><code>Expected: “1900-01-01”
Received: “1899-12-31”
</code></pre><p>Turns out my error was trusting Excel. For historical reasons, Excel has to support a bug where 1900 is falsely believed to be a leap year. This means that Excel believes there&rsquo;s an extra day between 01/01/1900 and 01/01/1970, impacting the value of <code>DAYS_OFFSET</code> in my function. It works fine for recent dates, but if I use the function for dates before the fictional leap day 29/02/1900 then the offset value is incorrect and I get an out by one error.</p><p>The moral of the story - think about whether your unit tests cover scenarios or edge cases that <em>will</em> occur in your app, and don&rsquo;t add unneeded unit tests. The project I&rsquo;m working on was never going to receive dates from the early 1900s and if I hadn&rsquo;t begun adding unnecessary tests I wouldn&rsquo;t have stumbled on this confusing error and spent 30 minutes questioning the space-time continuum.</p></article></main></div><footer class=footer><p class=footer__text>© 2022, Built with <a class=underline href=https://gohugo.io/ rel="noopener noreferrer nofollow" target=_blank>Hugo</a></p></footer></body></html>